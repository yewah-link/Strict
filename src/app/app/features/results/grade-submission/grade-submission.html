@if (!isLoading && submission) {
<div class="container-fluid p-4">
  <!-- Header -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="fw-bold mb-2">Grade Submission</h2>
        <p class="text-muted">{{ submission.examTitle }}</p>
      </div>
      <button class="btn btn-outline-secondary" (click)="backToList()">
        <i class="bi bi-arrow-left me-2"></i>Back to List
      </button>
    </div>
  </div>

  <!-- Centered Success Message -->
  @if (successMessage) {
    <div class="notification-overlay">
      <div class="notification-card success">
        <i class="bi bi-check-circle-fill notification-icon"></i>
        <p class="notification-message">{{ successMessage }}</p>
      </div>
    </div>
  }

  <!-- Centered Error Message -->
  @if (errorMessage) {
    <div class="notification-overlay">
      <div class="notification-card error">
        <i class="bi bi-exclamation-circle-fill notification-icon"></i>
        <p class="notification-message">{{ errorMessage }}</p>
        <button type="button" class="btn-close-notification" (click)="errorMessage = ''">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
  }

  <!-- Confirmation Modal -->
  @if (showConfirmModal) {
    <div class="notification-overlay">
      <div class="confirmation-modal">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle"></i> Confirm Action
          </h5>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ confirmMessage }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeConfirmDialog()">
            Cancel
          </button>
          <button type="button" class="btn btn-danger" (click)="confirmAction()">
            Confirm
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Student Info Card -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body py-3">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center gap-3">
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                 style="width: 40px; height: 40px; font-size: 1rem; flex-shrink: 0;">
              {{ submission.studentName.charAt(0) }}
            </div>
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-1">
                <h6 class="mb-0 fw-semibold">{{ submission.studentName }}</h6>
                <span class="text-muted small">â€¢</span>
                <span class="text-muted small">Reg No: {{ submission.studentRegNo }}</span>
              </div>
              <div class="d-flex gap-3 flex-wrap text-muted small">
                <span>
                  <i class="bi bi-envelope me-1"></i>{{ submission.studentEmail }}
                </span>
                <span>
                  <i class="bi bi-calendar me-1"></i>Submitted {{ formatDate(submission.submittedAt) }}
                </span>
                <span>
                  <i class="bi bi-clock me-1"></i>{{ submission.timeSpent }}
                </span>
                @if (submission.flaggedForReview) {
                <span class="badge bg-danger">
                  <i class="bi bi-exclamation-triangle me-1"></i>{{ submission.violations }} Violation(s)
                </span>
                }
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <div class="d-flex align-items-center justify-content-md-end gap-3">
            <div>
              <h4 class="mb-0 fw-bold">{{ totalScore }} <span class="text-muted fs-6">/ {{ submission.totalMarks }}</span></h4>
              <small class="text-muted">Total Score</small>
            </div>
            <span class="badge px-3 py-2" [ngClass]="'bg-' + getGradeColor()">
              {{ getPercentage() }}%
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Question Navigator Sidebar -->
    <div class="col-lg-3">
      <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
        <div class="card-header bg-white border-bottom">
          <h6 class="mb-0 fw-semibold">
            <i class="bi bi-list-ol me-2"></i>Questions
          </h6>
        </div>
        <div class="card-body p-2">
          <div class="d-grid gap-2">
            @for (question of submission.questions; track question; let i = $index) {
            <button
              class="btn btn-sm text-start d-flex justify-content-between align-items-center"
              [ngClass]="i === currentQuestionIndex ? 'btn-primary' : 'btn-outline-secondary'"
              (click)="goToQuestion(i)">
              <span>
                <i class="bi bi-circle-fill me-2"
                   [ngClass]="getQuestionStatusClass(question)"
                   style="font-size: 0.5rem;"></i>
                Q{{ i + 1 }}
              </span>
              <span class="badge"
                    [ngClass]="i === currentQuestionIndex ? 'bg-white text-primary' : 'bg-secondary'">
                {{ question.marks }}m
              </span>
            </button>
            }
          </div>

          <hr>

          <!-- Legend -->
          <div class="small">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-circle-fill text-success me-2" style="font-size: 0.5rem;"></i>
              <span>Full marks</span>
            </div>
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-circle-fill text-info me-2" style="font-size: 0.5rem;"></i>
              <span>Partial marks</span>
            </div>
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-circle-fill text-danger me-2" style="font-size: 0.5rem;"></i>
              <span>No marks</span>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi bi-circle-fill text-warning me-2" style="font-size: 0.5rem;"></i>
              <span>Not graded</span>
            </div>
          </div>

          <hr>

          <!-- Quick Actions -->
          <button class="btn btn-outline-primary btn-sm w-100 mb-2" (click)="autoGrade()">
            <i class="bi bi-magic me-2"></i>Auto-Grade MCQs
          </button>
          <button
            class="btn btn-success btn-sm w-100"
            (click)="submitGrading()"
            [disabled]="isSaving">
            <i class="bi bi-check-circle me-2"></i>Submit Grading
          </button>
        </div>
      </div>
    </div>

    <!-- Question Display and Grading Area -->
    <div class="col-lg-9">
      @if (getCurrentQuestion() && getCurrentAnswer()) {
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold">
              Question {{ currentQuestionIndex + 1 }} of {{ submission.questions.length }}
            </h6>
            <div>
              <span class="badge bg-primary me-2">{{ getCurrentQuestion()!.questionType }}</span>
              <span class="badge bg-secondary">{{ getCurrentQuestion()!.marks }} marks</span>
            </div>
          </div>
        </div>

        <div class="card-body">
          <!-- Question Text -->
          <div class="mb-4">
            <h6 class="text-muted small mb-2">QUESTION</h6>
            <p class="fs-5 mb-0">{{ getCurrentQuestion()!.questionText }}</p>
          </div>

          <!-- MCQ Options (if applicable) -->
          @if (getCurrentQuestion()!.options) {
          <div class="mb-4">
            <h6 class="text-muted small mb-2">OPTIONS</h6>
            <div class="list-group">
              @for (option of getCurrentQuestion()!.options; track option) {
              <div
                class="list-group-item border"
                [ngClass]="{
                  'list-group-item-success border-success': option.text === getCurrentQuestion()!.correctAnswer,
                  'list-group-item-primary border-primary': option.id === getCurrentAnswer()!.selectedChoiceId && option.isCorrect,
                  'list-group-item-danger border-danger': option.id === getCurrentAnswer()!.selectedChoiceId && !option.isCorrect
                }">
                <i class="bi me-2"
                   [ngClass]="{
                     'bi-check-circle-fill text-success': option.text === getCurrentQuestion()!.correctAnswer,
                     'bi-x-circle-fill text-danger': option.id === getCurrentAnswer()!.selectedChoiceId && !option.isCorrect,
                     'bi-circle': option.id !== getCurrentAnswer()!.selectedChoiceId && option.text !== getCurrentQuestion()!.correctAnswer
                   }"></i>
                {{ option.text }}
              </div>
              }
            </div>
          </div>
          }

          <!-- Student Answer -->
          <div class="mb-4">
            <h6 class="text-muted small mb-2">STUDENT'S ANSWER</h6>
            <div class="alert border"
                 [ngClass]="{
                   'alert-success border-success': getCurrentAnswer()!.isCorrect === true,
                   'alert-danger border-danger': getCurrentAnswer()!.isCorrect === false,
                   'alert-secondary': getCurrentAnswer()!.isCorrect === undefined
                 }">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <p class="mb-0" style="white-space: pre-wrap;">{{ getCurrentAnswer()!.studentAnswer || '(No answer provided)' }}</p>
                </div>
                @if (getCurrentAnswer()!.isCorrect !== undefined) {
                <div class="ms-3">
                  <i class="bi fs-4"
                     [ngClass]="getCurrentAnswer()!.isCorrect ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger'"></i>
                </div>
                }
              </div>
            </div>
          </div>

          <!-- Correct Answer (if available) -->
          @if (getCurrentQuestion()!.correctAnswer) {
          <div class="mb-4">
            <h6 class="text-muted small mb-2">CORRECT ANSWER</h6>
            <div class="alert alert-info border border-info mb-0">
              <i class="bi bi-info-circle me-2"></i>
              {{ getCurrentQuestion()!.correctAnswer }}
            </div>
          </div>
          }

          <!-- Grading Section -->
          <div class="card bg-light border-0 mt-4">
            <div class="card-body">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="form-label fw-semibold small">MARKS AWARDED</label>
                  <div class="input-group input-group-lg">
                    <input
                      type="number"
                      class="form-control"
                      [min]="0"
                      [max]="getCurrentQuestion()!.marks"
                      [(ngModel)]="getCurrentAnswer()!.marksAwarded"
                      (ngModelChange)="updateMarks(getCurrentAnswer()!, $event)"
                      placeholder="0">
                    <span class="input-group-text">/ {{ getCurrentQuestion()!.marks }}</span>
                  </div>
                </div>

                <div class="col-md-8">
                  <label class="form-label fw-semibold small">FEEDBACK (OPTIONAL)</label>
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    [(ngModel)]="getCurrentAnswer()!.feedback"
                    placeholder="Add feedback for the student...">
                </div>
              </div>

              <!-- Quick Mark Buttons -->
              <div class="mt-3 d-flex gap-2 flex-wrap">
                <button
                  class="btn btn-sm btn-outline-success"
                  (click)="updateMarks(getCurrentAnswer()!, getCurrentQuestion()!.marks)">
                  <i class="bi bi-check-circle me-1"></i>Full Marks
                </button>
                <button
                  class="btn btn-sm btn-outline-warning"
                  (click)="updateMarks(getCurrentAnswer()!, Math.floor(getCurrentQuestion()!.marks / 2))">
                  <i class="bi bi-dash-circle me-1"></i>Half Marks
                </button>
                <button
                  class="btn btn-sm btn-outline-danger"
                  (click)="updateMarks(getCurrentAnswer()!, 0)">
                  <i class="bi bi-x-circle me-1"></i>Zero Marks
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Footer -->
        <div class="card-footer bg-white border-top">
          <div class="d-flex justify-content-between align-items-center">
            <button
              class="btn btn-outline-secondary"
              [disabled]="currentQuestionIndex === 0"
              (click)="previousQuestion()">
              <i class="bi bi-arrow-left me-2"></i>Previous
            </button>

            <span class="text-muted small">
              Progress: {{ currentQuestionIndex + 1 }} / {{ submission.questions.length }}
            </span>

            <button
              class="btn btn-primary"
              [disabled]="currentQuestionIndex === submission.questions.length - 1"
              (click)="nextQuestion()">
              Next<i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
      </div>
      }

      <!-- Summary Card -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h6 class="mb-0 fw-semibold">
            <i class="bi bi-bar-chart me-2"></i>Grading Summary
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3 text-center mb-4">
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <h3 class="fw-bold text-primary mb-1">{{ totalScore }}</h3>
                  <small class="text-muted">Total Score</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <h3 class="fw-bold text-success mb-1">{{ getPercentage() }}%</h3>
                  <small class="text-muted">Percentage</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <h3 class="fw-bold text-info mb-1">{{ autoGradedCount }}</h3>
                  <small class="text-muted">Auto-Graded</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 bg-light h-100">
                <div class="card-body">
                  <h3 class="fw-bold text-warning mb-1">{{ manualGradedCount }}</h3>
                  <small class="text-muted">Manual-Graded</small>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <button
              class="btn btn-outline-secondary"
              (click)="saveProgress()"
              [disabled]="isSaving">
              <i class="bi bi-save me-2"></i>
              {{ isSaving ? 'Saving...' : 'Save Progress' }}
            </button>

            <button
              class="btn btn-success"
              (click)="submitGrading()"
              [disabled]="isSaving">
              <i class="bi bi-check-circle me-2"></i>
              {{ isSaving ? 'Submitting...' : 'Submit Grading' }}
            </button>
          </div>

          @if (!isSubmissionComplete()) {
          <div class="alert alert-warning border border-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> Not all questions have been graded yet.
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
}

<!-- Loading State -->
@if (isLoading) {
<div class="container-fluid py-5 text-center">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="text-muted mt-3">Loading submission details...</p>
</div>
}